<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no">
	<!--	html缓存问题-->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>医技预约自助机</title>
	<link rel="stylesheet" href="../css/index.css?v=1.0.38"/>
	<link rel="stylesheet" href="../css/inspectCheck.css?v=1.0.38">
	<link rel="stylesheet" href="../css/popup.css?v=1.0.38">
	<link rel="stylesheet" href="../css/msgbox.css?v=1.0.38" />
	<script type="text/javascript" src="../js/jquery-1.11.0.js?v=1.0.38"></script>
	<script src="../js/json2.js?v=1.0.38"></script>
	<script type="text/javascript" src="../js/msgbox.js?v=1.0.38"></script>
	<script type="text/javascript" src="../util/public.js?v=1.0.38"></script>
	<!--[if IE]>
	<script src="../util/base64-polyfill.js?v=1.0.38"></script>
	<![endif]-->
</head>
<body>
<!--签到缴费 -->
<div class="homePage_title">
	<div class="homePage_title_logo">
		<div class="homePage_title_left">
			<img src="../images/index_img/log.png" alt="logo">
		</div>
		<div class="homePage_title_right">
			<p id="timer"></p>
		</div>
		<div class="clear"></div>
	</div>
	<div class="user_info">
		   <div class="backHome" id="clickBackHome">
			<a>
				首页
			</a>
		</div>
		<div class="user_info_left" >
			<p>欢迎使用!</p>
			<span>姓名:</span><span class="name">xxx</span>
			<span>性别:</span><span class="sex">xx</span>
			<span>年龄:</span><span class="age">xx</span>
		</div>
		<div class="user_info_right">
			<h2>操作倒计时:<span id="clock"></span>秒</h2>
		</div>
		<div class=" user_info_right backBtn">
            <h6>返回上一页</h6>
        </div>
		<div class="clear"></div>
	</div>
</div>
<div class="xiaopiao" style="display:none">
	<div class="printtext" style="background: #fff;width: 260px;" >
		<div class="text" style="font-size: 20px;font-weight: bold;text-align:center;">
			<div class="text" style="font-size: 20px;font-weight: bold;text-align:center;">西北妇女儿童医院</br>预约扣费凭证</div></div>
		<div class="tt" style="margin: 0 auto;height: 20px;width: 260px;line-height: 20px;">
			<span class="p1" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;float:left;">姓名:</span>
			<span class="p2" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;float:right;">诊疗号:</span>
		</div>
		<div class="mm" style="margin: 0 auto;height: 20px;width: 260px;line-height: 20px;border-bottom:1px solid #000;">
			<span class="p1" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;float:left;">执行科室: </span>
			<span class="p2" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;float:right;">申请单号:</span>
		</div>
		<div class="dd" style="margin: 0 auto;margin-top: 0px;margin-left: 0px;width: 260px;border-bottom:1px solid #000;">
			<p class="p1" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">预约组:</p>
			<p class="p2" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">排队号:</p>
			<p class="p3" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">预约项目:</p>
			<p class="p4" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">预约时间:</p>
			<p class="p5" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">扣费时间:</p>
			<p class="p6" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">打印时间:</p>
			<p class="p7" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">支付金额:元</p>
		</div>
		<div class="ff" style="height: 80px;width: 260px;line-height: 30px;border-bottom:1px solid #000;font-size: 12px;">申请单号:
			<div id="image002" style="margin-bottom:5px;margin-left:50px;"></div>
		</div>
		<div class="ff" style="height: auto;width: 260px;line-height: 30px;border-bottom:1px solid #000;font-size: 12px;">
			<p class="remark">注意事项：</p>
		</div>
		<div class="ff"  style="height: 60px;width: 260px;line-height: 30px;font-size: 12px;">
			<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">温馨提示:</p>
			<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">1.胎心监护请勿空腹以免影响检查</p>
			<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">2.请您提前在候诊区等待呼叫</p>
		</div>
	</div>
</div>
<div class="inspeckCheck_content">
	<div class="content_left" id="contentLeft">
		<div class="clear"></div>
	</div>
	<div class="content_right">
		<div class="prev">上一页</div>
		<span>
			<span class="pageNum">1</span>
			/
			<span class="pageNo">1</span>
		</span>
		<div class="next">下一页</div>
	</div>
	<div class="clear"></div>
</div>
<!-- 无签到缴费 -->
<div class="reserSuccess" style="display: none">
    <div class="reservationInf">
        <h2>温馨提示</h2>
        <p style="margin: 18% 0;">您没有可签到缴费的申请单！</p>
    </div>
</div>
<div class="tipPopup-mask"></div>
</body>
</html>
<script src="../util/http.js?v=1.0.38"></script>
<script src="../util/util.js?v=1.0.38"></script>
<script type="text/javascript" src="../util/jquery-barcode.js?v=1.0.38" charset="utf-8"></script>
<script src="../util/LodopFuncs.js?v=1.0.38"></script>

<script src="../js/popup.js?v=1.0.38"></script>
<script type="text/javascript">
	$(".tipPopup-mask").css("display", "block")
	$(".content_right").css("display", "none")
	ZENG.msgbox.show("正在加载中，请稍后...", 6, 10000);

	countdown('92530018103527854',true);
   //调用接口数据
   var pageNo = 1;
   var pageNum = 4;
	var pageSize = 4;
	var data={
				"pageNo": pageNo,
				"pageNum": pageNum,
            	"pageSize": pageSize,
				"patientId":localStorage.getItem("patientId"),
				"type": 2
		 };
	getData(data);
    var getRes = '';
    function getData(data){
		post('selfMachine/queryPatientApplySignList',data,function(res){
			if(res.code === 200){
				var od = document.getElementById("contentLeft");
				od.innerHTML = ''
				res = res.result;
				getRes  = res;
				if(res.list == null  ){
					ZENG.msgbox._hide();
					$(".tipPopup-mask").css("display", "none")
					$('.reserSuccess').css('display','block');
					$('.inspeckCheck_content').css('display','none');
				}else{
					if(res.list.length==0|| res.list == []){
						ZENG.msgbox._hide();
						$(".tipPopup-mask").css("display", "none")
						$('.reserSuccess').css('display','block');
						$('.inspeckCheck_content').css('display','none');
					}else{
						ZENG.msgbox._hide();
						$(".tipPopup-mask").css("display", "none")
						$(".content_right").css("display", "block")
						$('.pageNum').html(getRes.pageNum);
						$('.pageNo').html(getRes.pages);
						for(var i=0;i<res.list.length;i++){
							var remarks ='';
							if (res.list[i].remarks == '' || res.list[i].remarks == '|' || res.list[i].remarks == null) {
								remarks = '无'
							}else{
								var array = res.list[i].remarks.split("|");
								remarks = array.join('')
							}
							op= '<div class="apply_info voucherInfo">'+
									'<p>'+'<span class="selectionName">'+ '申请单号：'+'</span>' + '<span class="selectionContent">'+res.list[i].inspectForm +'</span>'+'</p>'+
									'<p>'+'<span class="selectionName">'+ '申请科室：'+'</span>' + '<span class="selectionContent">'+res.list[i].applyOffice +'</span>'+'</p>'+
									'<p>'+'<span class="selectionName">'+ '申请医生：'+'</span>' + '<span class="selectionContent">'+res.list[i].applyDoctor +'</span>'+'</p>'+
									'<p>'+'<span class="selectionName">'+ '预约时间：'+'</span>' + '<span class="selectionContent">'+res.list[i].reservationTime +'</span>'+'</p>'+
									'<p>'+'<span class="selectionName">'+ '检查项目：'+'</span>' + '<span class="selectionContent">'+res.list[i].inspectProject +'</span>'+'</p>'+
									'<p>'+'<span class="selectionName">'+ '合计金额：'+'</span>' + '<span class="selectionContent">'+res.list[i].totalMoney +'元' + '</span>'+'</p>'+
									'<p>'+'<span class="selectionName">'+ '状'+ '    '+'态：'+'</span>'+'<span class="selectionContent">'+res.list[i].status +'</span>'+'</p>'+
									'<p class="remarks">'+'<span class="selectionName">'+ '注意事项：' + '</span>'+'<span class="selectionContent">'+ remarks +'</span>'+'</p>'+
									'<div class="signIn">' + '签到' + '</div>' +
									'</div>'
							od.innerHTML += op;
						}
					}

				}
			}else{
				ZENG.msgbox.show( res.message, 5, 2000);
				setTimeout(function(){
					window.location.href = "index.html?patientId="+localStorage.getItem("patientId");
				},2000)
			}
        },function(){
            //console.log("提交失败！")
        })
    }
	var that = this;
	// 点击下一个页
	$('.next').click(function(){
		if(getRes.nextPage >0){
			var data = {
					"pageNo": ++pageNo,
					"pageNum": pageNum,
					"pageSize": pageSize,
					"patientId":localStorage.getItem("patientId"),
					"type": 2
				};
			getData(data);
		}else{
			//console.log('最后一页');
		}
	});
	//点击下一页
	$('.prev').click(function(){
		if(getRes.prePage>0){
			var data = {
					"pageNo": --pageNo,
					"pageNum": pageNum,
					"pageSize": pageSize,
					"patientId":localStorage.getItem("patientId"),
					"type": 2
				}
			getData(data);
		}else{
			//console.log('第一页');
		}
	});
   //点击签到
	var payData = null
	$('.content_left').on('click','.signIn',function(){
		var index = $(this).index('.signIn');
		payData =  getRes.list[index]
		var remarks = payData.remarks;
		if ( remarks == '' ||  remarks == '|' || remarks == null) {
                remarks = '无'
         }else{
			var array = remarks.split("|");
			remarks = array.join('')
        }
		var loadHours = new Date().getHours();
      	var now = new Date;
		now.setMinutes(now.getMinutes() + 10)
	   var loadMinutes = now.getMinutes(); //获取当前的分钟
	   var date = payData.reservationTime.substring(0, 10);
	   var queryCount = {
			classesDate:date,  //当前点击的日期
			officeId:payData.officeId ,  //科室id
			reservableSourcePoolId:payData.reservableSourcePoolId  //号源池id
		};
		// 查询排班
		post("selfMachine/queryCheckInSchedulingPlan", queryCount, function (res) {
				if(res.result.length > 0){
					var baseTimes = res.result[res.result.length - 1].sectionNumber,
					resHours = baseTimes.substring(6, 8),
					resMinutes = baseTimes.substring(9, 11);
					if (loadHours < Number(resHours) || (loadHours === Number(resHours) && Number(resMinutes) > loadMinutes)) { //符合条件进行页面的调转
						var popup = new Popup({
							'type': 'submit',
							'title': '温馨提示',
							'text': '注意事项:' + remarks,
							'cancelbutton': true,
							'submitcolor': '#fff',
							'submitbgcolor': '#5BC67E',
							'submitbordercolor': '#5BC67E',
							'cancelcolor': '#5BC67E',
							'cancelbgcolor': '#fff',
							'cancelbordercolor': '#5BC67E',
							'submitCallBack': function(){
								var resdata={
									reservationId:payData.reservationId,
									reservationType:1     //预约类型  检查 1    检验 2
								}
								// 查询是否需要缴费接口    queryInspectFormStatus
								post("selfMachine/queryInspectFormStatus", resdata, function (res) {
											if(res.result==10 || res.result=="10" ){
												var paydata={
													"currentLatitude":'34.198499',
													"currentLongitude":'109.028594',
													"inspectForm":payData.inspectForm,
													"money":payData.totalMoney,
													"officeId":payData.officeId,
													"patientId":localStorage.getItem("patientId"),
													"reservationId":payData.reservationId,
													"type":1,
													"userId": localStorage.getItem("patientId"),
													"userName": patientInfo.patientName
												}
												post("selfMachine/directSignUp", paydata, function (res) {
													if(res.code==200){
														$(".tipPopup-mask").css("display", "block")
														ZENG.msgbox.show("签到成功，正在打印支付小票,请稍等...", 4, 2000);
														setTimeout(function(){
															$(".tipPopup-mask").css("display", "none")
														},2000)
														post('selfMachine/findSelfReceiptByReservationId/'+ payData.reservationId,{},function(res){
															data = res.result;
															setTimeout(function(){
																print();
															},2000)
														},function(){
															//console.log("提交失败！")
														})
													}else{
														ZENG.msgbox.show(res.message, 5, 2000);
														$(".tipPopup-mask").css("display", "block")
														setTimeout(function(){
															$(".tipPopup-mask").css("display", "none")
														},2000)
													}
												},
												function () {
													//console.log("提交失败！")
												});
											}else if(res.result==20 || res.result=="20"){
												if(payData.totalMoney==0){
													var paydata={
														"currentLatitude":'34.198499',
														"currentLongitude":'109.028594',
														"inspectForm":payData.inspectForm,
														"money":payData.totalMoney,
														"officeId":payData.officeId,
														"patientId":localStorage.getItem("patientId"),
														"reservationId":payData.reservationId,
														"type":1,
														"userId": localStorage.getItem("patientId"),
														"userName": patientInfo.patientName
													}
													post("selfMachine/directSignUp", paydata, function (res) {
																if(res.code==200){
																	$(".tipPopup-mask").css("display", "block")
																	ZENG.msgbox.show("签到成功，正在打印支付小票...", 4, 2000);
																	setTimeout(function(){
																		$(".tipPopup-mask").css("display", "none")
																	},2000)
																	post('selfMachine/findSelfReceiptByReservationId/'+ payData.reservationId,{},function(res){
																		// console.log(res)
																		data = res.result;
																		setTimeout(function(){
																			print();
																		},2000)
																	},function(){
																		//console.log("提交失败！")
																	})
																}else{
																	ZENG.msgbox.show(res.message, 5, 2000);
																	$(".tipPopup-mask").css("display", "block")
																	setTimeout(function(){
																		$(".tipPopup-mask").css("display", "none")
																	},2000)
																}
															},
															function () {
																//console.log("提交失败！")
															});
												}else{
													window.location.href = "payment.html?" +  window.btoa(window.encodeURIComponent('item=' + JSON.stringify(payData)))
												}

											}
								},
								function () {
									//console.log("提交失败！")
								});
							},
						})
					}else{
						ZENG.msgbox.show("日期超出范围,签到失败！", 5, 2000);
						$(".tipPopup-mask").css("display", "block")
						setTimeout(function(){
							$(".tipPopup-mask").css("display", "none")
						},2000)
					}
				}else{
					ZENG.msgbox.show("日期超出范围,签到失败！", 5, 2000);
					$(".tipPopup-mask").css("display", "block")
					setTimeout(function(){
						$(".tipPopup-mask").css("display", "none")
					},2000)
				}
		},
        function () {
            //console.log("提交失败！")
        })
	})

	// 打印小票
	function print(){
		var patientInfo = JSON.parse(localStorage.getItem("records"))
		var currentDate = new Date()
		var currentDateStr = currentDate.toLocaleString()
		var LODOP = getLodop()
		// LODOP.PRINT_INIT('西北妇女儿童医院预约扣费凭证')
		var payDate=data.payDate;
		if (payDate == null || payDate === undefined) {
			payDate = '无';
		}
		var remarks = data.remarks
		if (remarks == null || remarks === undefined) {
			remarks = '无'
		}
		$('.tt .p1').html('姓名:' + patientInfo.patientName)
		$('.tt .p2').html('诊疗号:' + data.patientId)
		$('.mm .p1').html('执行科室:' + data.execOfficeName)
		$('.mm .p2').html('申请单号:' + data.inspectForm)
		$('.dd .p1').html('预约组:' + data.reservationGroupName)
		$('.dd .p2').html('排队号:' + data.lineCode)
		$('.dd .p3').html('预约项目:' + data.inspectProject )
		$('.dd .p4').html('预约时间:' + data.reservationTime)
		$('.dd .p5').html('扣费时间:' + payDate)
		$('.dd .p6').html('打印时间:' + currentDateStr)
		$('.dd .p7').html('支付金额:' + data.totalMoney + '元')
		$("#image002").barcode(data.inspectForm , "code128", {
			output: 'css',       //渲染方式 css/bmp/svg/canvas
			//bgColor: '#ff0000', //条码背景颜色
			//color: '#00ff00',   //条码颜色
			barWidth: 2,        //单条条码宽度
			barHeight: 45,     //单体条码高度
			// moduleSize: 10,   //条码大小
			// posX: 10,        //条码坐标X
			// posY: 5,         //条码坐标Y
			showHRI: false,    //是否在条码下方显示内容
			addQuietZone: false  //是否添加空白区（内边距）
		})
		$(".remark").html('注意事项：'+remarks)

		// var printContent = '<div class="printtext" style="background: #fff;width: 260px;" >' +
		// 		'<div class="text" style="font-size: 20px;font-weight: bold;text-align:center;">\n' +
		// 		'<div class="text" style="font-size: 20px;font-weight: bold;text-align:center;">西北妇女儿童医院</br>预约扣费凭证</div></div>' +
		// 		'<div class="tt" style="margin: 0 auto;height: 20px;width: 260px;line-height: 20px;">' +
		// 		'<span class="p1" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;float:left;">姓名:' + patientInfo.patientName + '</span>' +
		// 		'<span class="p2" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;float:right;">诊疗号:' + data.patientId + '</span>' +
		// 		'</div>' +
		// 		'<div class="mm" style="margin: 0 auto;height: 20px;width: 260px;line-height: 20px;border-bottom:1px solid #000;">' +
		// 		'<span class="p1" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;float:left;">执行科室:' + data.execOfficeName + ' </span>' +
		// 		'<span class="p2" style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;float:right;">申请单号:' + data.inspectForm + '</span>' +
		// 		'</div>' +
		// 		'<div class="dd" style="margin: 0 auto;margin-top: 0px;margin-left: 0px;width: 260px;border-bottom:1px solid #000;">' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">预约组:' + data.reservationGroupName + '</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">排队号:' + data.lineCode + '</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">预约项目:' + data.inspectProject + '</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">预约时间:' + data.reservationTime + '</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">打印时间:' + currentDateStr + '</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">支付金额:' + data.totalMoney + '元</p>' +
		// 		'</div>' +
		// 		'<div class="ff" style="height: 65px;width: 260px;line-height: 30px;border-bottom:1px solid #000;font-size: 12px;">申请单号:' +
		// 		'<img id="image001" style="margin-bottom:5px;" src="'+url+'"/>' +
		// 		'</div>' +
		// 		'<div class="ff" style="height: auto;width: 260px;line-height: 30px;border-bottom:1px solid #000;font-size: 12px;">' +
		// 		'<p>注意事项：' + remarks + '</p>' +
		// 		'</div>' +
		// 		'<div class="ff" style="height: 60px;width: 260px;line-height: 30px;font-size: 12px;">' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">温馨提示:</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">1.胎心监护请勿空腹以免影响检查</p>' +
		// 		'<p style="margin: 0 auto;height: 20px;line-height: 20px;font-size: 12px;margin-top: 0px;">2.请您提前在候诊区等待呼叫</p>' +
		// 		'</div></div>'
		var printContent=$(".xiaopiao").html();
        if(LODOP){
			if (LODOP.CVERSION) {//判断c_lodop是否存在，安装了c-lodop就会存在
				// 设置纸张大小 打印方向
				LODOP.SET_PRINT_PAGESIZE(1, 780, 1200, '');
				// 指定位置增加文本
				LODOP.ADD_PRINT_HTM(0, 0, '100%', '100%', printContent);
				//执行该语句之后，PRINT指令不再返回那个所谓“打印成功”
				LODOP.SET_PRINT_MODE("CATCH_PRINT_STATUS",true);
				LODOP.On_Return=function(TaskID,Value){
					var timer = setInterval(function(){
						if(getStatusValue("PRINT_STATUS_EXIST",Value)==0){
							post('selfMachine/saveReservatPrintByReservationId/'+ payData.reservationId,{},function(res){
								if(res.code == 200){
									$(".tipPopup-mask").css("display", "block")
									ZENG.msgbox.show("打印成功，正在返回首页...",4,2000);
									setTimeout(function(){
										window.location.href = "index.html?patientId="+localStorage.getItem("patientId");
									},2000)
								}else{
									$(".tipPopup-mask").css("display", "block")
									ZENG.msgbox.show("打印失败，正在返回首页...",1,2000);
									setTimeout(function(){
										window.location.href = "index.html?patientId="+localStorage.getItem("patientId");
									},2000)
								}
							})
							clearInterval(timer);
						}
					},1000);
				};
				LODOP.PRINT();
			} else{
				ZENG.msgbox.show("数据获取失败", 5, 2000);
				setTimeout(function(){
					window.location.href = "index.html?patientId="+localStorage.getItem("patientId");
				},2000)
			}
			strResult=LODOP.GET_SYSTEM_INFO("Drive.Labels");
		} else {
			ZENG.msgbox.show("打印控件未启动!", 5, 2000);
			setTimeout(function(){
				window.location.href = "index.html?patientId="+localStorage.getItem("patientId");
			},2000)
		}
	}
	function getStatusValue(ValueType,ValueIndex){
		LODOP=getLodop();
		var strResult=LODOP.GET_VALUE(ValueType,ValueIndex);
		if (!LODOP.CVERSION) return strResult; else return "";
	}
</script>
